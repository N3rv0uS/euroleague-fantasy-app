name: Smoke Incrowd (player gamelogs)

on:
  workflow_dispatch:
    inputs:
      season:      { description: "Season", required: true, default: "2025" }
      competition: { description: "E or U", required: true, default: "E" }
      mode:        { description: "perGame", required: true, default: "perGame" }
      players:     { description: "Comma list player_code (π.χ. 002661,011196)", required: false, default: "" }
      out_dir:     { description: "Output dir", required: true, default: "out" }

permissions:
  contents: write

jobs:
  probe:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: Run Incrowd gamelogs (smoke)
        run: |
          python gamelogs_incrowd.py \
            --season "${{ github.event.inputs.season }}" \
            --competition "${{ github.event.inputs.competition }}" \
            --mode "${{ github.event.inputs.mode }}" \
            --players "${{ github.event.inputs.players }}" \
            --out_dir "${{ github.event.inputs.out_dir }}"

      - name: List outputs
        run: ls -lah "${{ github.event.inputs.out_dir }}" || true

      - name: Commit & push outputs
        run: |
          set -e
          git config --global safe.directory "$GITHUB_WORKSPACE"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ github.event.inputs.out_dir }}/player_gamelogs_${{ github.event.inputs.season }}_${{ github.event.inputs.mode }}.csv" || true
          git commit -m "data: Incrowd gamelogs ${{ github.event.inputs.season }} (${{ github.event.inputs.mode }}) [smoke]" || echo "No changes"
          git -c rebase.autoStash=true pull --rebase
          git push
